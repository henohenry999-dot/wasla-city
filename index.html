<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙˆØµÙ„Ø© | Ø¯Ù„ÙŠÙ„ Ø­Ø¯Ø§Ø¦Ù‚ Ø§Ù„Ø¹Ø§ØµÙ…Ø©</title>
    
    <meta name="theme-color" content="#1e3799">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192.png?text=ÙˆØµÙ„Ø©">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e3799;       
            --secondary: #27ae60;     
            --accent: #fbc531;   
            --dark: #2c3e50;
            --light: #f4f6f8;
            --white: #ffffff;
            --gray: #95a5a6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: var(--light); color: var(--dark); padding-bottom: 90px; user-select: none; }
        a { text-decoration: none; }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header { background: linear-gradient(135deg, #0c2461, #1e3799); color: white; padding: 15px 20px 25px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 900; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .logo { font-size: 1.5rem; font-weight: 900; display: flex; align-items: center; gap: 8px; }
        .logo i { color: var(--accent); }
        .install-btn { background: rgba(255,255,255,0.2); font-size: 0.8rem; padding: 5px 12px; border-radius: 20px; cursor: pointer; display: none; }

        /* --- Ø§Ù„Ø¨Ø­Ø« --- */
        .search-container { position: relative; margin-top: -25px; padding: 0 15px; z-index: 910; }
        .search-box { width: 100%; padding: 12px 45px 12px 15px; border-radius: 15px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-family: 'Cairo'; font-size: 1rem; outline: none; }
        .search-icon { position: absolute; top: 12px; right: 30px; color: var(--gray); }

        /* --- Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Chips) --- */
        .cats-wrap { overflow-x: auto; white-space: nowrap; padding: 15px; scrollbar-width: none; }
        .cat-chip { display: inline-block; padding: 8px 16px; background: white; border-radius: 25px; margin-left: 8px; font-size: 0.9rem; color: var(--dark); border: 1px solid #eee; transition: 0.2s; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(30, 55, 153, 0.2); }

        /* --- Ø§Ù„Ø´Ø¨ÙƒØ© --- */
        .container { padding: 0 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 15px; min-height: 50vh; }
        @media(min-width: 600px) { .container { grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); } }

        .card { background: white; border-radius: 16px; padding: 10px; display: flex; gap: 12px; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: 0.2s; border: 1px solid transparent; }
        .card.featured { border: 1px solid var(--accent); background: #fffdf2; }
        
        .card-img { width: 85px; height: 85px; border-radius: 12px; object-fit: cover; background: #eee; flex-shrink: 0; }
        .card-body { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .card h3 { margin: 0 0 4px; font-size: 1rem; color: var(--primary); line-height: 1.3; }
        .sub-text { font-size: 0.8rem; color: var(--gray); display: flex; align-items: center; gap: 5px; }
        
        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙƒØ§Ø±Øª (Ù‚Ù„Ø¨ + Ù…Ø´Ø§Ø±ÙƒØ©) */
        .card-tools { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; }
        .tool-btn { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; color: var(--gray); box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .tool-btn.fav.active { color: #e74c3c; }
        .tool-btn:active { transform: scale(0.9); }

        /* Ø­Ø§Ù„Ø© Ù…ØªØ§Ø­ */
        .status-dot { width: 10px; height: 10px; background: var(--secondary); border-radius: 50%; position: absolute; top: 10px; right: 10px; box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);} 100% {box-shadow: 0 0 0 5px rgba(46, 204, 113, 0);} }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ (Bottom Nav) --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--gray); font-size: 0.75rem; cursor: pointer; transition: 0.2s; position: relative; }
        .nav-item i { font-size: 1.4rem; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.active::after { content: ''; width: 5px; height: 5px; background: var(--primary); border-radius: 50%; margin-top: 2px; }

        /* --- Skeleton Loading (Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ) --- */
        .skeleton { background: #e0e0e0; border-radius: 8px; animation: shimmer 1.5s infinite linear; background: linear-gradient(to right, #eff1f3 4%, #e2e2e2 25%, #eff1f3 36%); background-size: 1000px 100%; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .sk-card { height: 110px; background: white; border-radius: 16px; padding: 10px; display: flex; gap: 12px; margin-bottom: 15px; }
        .sk-img { width: 85px; height: 85px; border-radius: 12px; }
        .sk-line { height: 12px; margin-bottom: 8px; border-radius: 4px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 5000; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-box { background: white; margin: 15% auto; width: 90%; max-width: 500px; border-radius: 20px; overflow: hidden; position: relative; animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform:translateY(100px);} to {transform:translateY(0);} }

        /* Fab */
        .fab-add { position: fixed; bottom: 85px; left: 20px; background: var(--primary); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 5px 15px rgba(30, 55, 153, 0.3); z-index: 90; transition: 0.3s; }
        .fab-add:active { transform: scale(0.9); }
    </style>
</head>
<body>

<header>
    <div class="nav-bar">
        <div class="logo"><i class="fas fa-map-location-dot"></i> ÙˆØµÙ„Ø©</div>
        <div id="installBtn" class="install-btn">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“²</div>
    </div>
    <div style="text-align: center; color: rgba(255,255,255,0.9); margin-bottom: 15px;">
        <h2 style="margin:0; font-size:1.4rem;">Ø¯Ù„ÙŠÙ„ Ø­Ø¯Ø§Ø¦Ù‚ Ø§Ù„Ø¹Ø§ØµÙ…Ø©</h2>
    </div>
</header>

<div class="search-container">
    <i class="fas fa-search search-icon"></i>
    <input type="text" id="search" class="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† (Ù…Ø·Ø¹Ù…ØŒ Ø³Ø¨Ø§ÙƒØŒ Ø¯ÙƒØªÙˆØ±)...">
</div>

<div class="cats-wrap" id="catsContainer">
    <div class="cat-chip active" onclick="filter('all', this)">Ø§Ù„ÙƒÙ„</div>
    <div class="cat-chip" onclick="filter('food', this)">ğŸ” Ù…Ø·Ø§Ø¹Ù…</div>
    <div class="cat-chip" onclick="filter('market', this)">ğŸ›’ Ù…Ø§Ø±ÙƒØª</div>
    <div class="cat-chip" onclick="filter('medical', this)">ğŸ’Š Ø·Ø¨ÙŠØ©</div>
    <div class="cat-chip" onclick="filter('maintenance', this)">ğŸ”§ ØµÙŠØ§Ù†Ø©</div>
    <div class="cat-chip" onclick="filter('transport', this)">ğŸšŒ Ù…ÙˆØ§ØµÙ„Ø§Øª</div>
    <div class="cat-chip" onclick="filter('gov', this)">ğŸ›ï¸ Ø­ÙƒÙˆÙ…ÙŠ</div>
</div>

<div class="container" id="grid">
    <div class="sk-card"><div class="sk-img skeleton"></div><div style="flex:1"><div class="sk-line skeleton" style="width:60%"></div><div class="sk-line skeleton" style="width:40%"></div></div></div>
    <div class="sk-card"><div class="sk-img skeleton"></div><div style="flex:1"><div class="sk-line skeleton" style="width:70%"></div><div class="sk-line skeleton" style="width:30%"></div></div></div>
    <div class="sk-card"><div class="sk-img skeleton"></div><div style="flex:1"><div class="sk-line skeleton" style="width:50%"></div><div class="sk-line skeleton" style="width:40%"></div></div></div>
</div>

<a href="https://forms.gle/iGmmzXMt9amqkepu7" target="_blank" class="fab-add"><i class="fas fa-plus"></i></a>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
    <div class="nav-item" onclick="switchTab('fav', this)"><i class="fas fa-heart"></i><span>Ø§Ù„Ù…ÙØ¶Ù„Ø©</span></div>
    <div class="nav-item" onclick="switchTab('offers', this)"><i class="fas fa-tags"></i><span>Ø§Ù„Ø¹Ø±ÙˆØ¶</span></div>
    <div class="nav-item" onclick="window.open('https://wa.me/?text=ØªØ·Ø¨ÙŠÙ‚ ÙˆØµÙ„Ø©', '_blank')"><i class="fas fa-share-alt"></i><span>Ù†Ø´Ø±</span></div>
</div>

<div id="modal" class="modal" onclick="if(event.target==this)closeM()">
    <div class="modal-box">
        <span onclick="closeM()" style="position:absolute; top:15px; left:15px; background:rgba(0,0,0,0.6); color:white; width:30px; height:30px; text-align:center; line-height:30px; border-radius:50%; cursor:pointer; z-index:10;">âœ•</span>
        <img id="mImg" src="" style="width:100%; height:220px; object-fit:cover;">
        <div style="padding:20px;">
            <h2 id="mName" style="color:var(--primary); margin:0 0 5px;"></h2>
            <div id="mSub" style="color:#777; font-size:0.9rem;"></div>
            <p id="mDesc" style="color:#333; line-height:1.6; margin:15px 0; font-size:0.95rem;"></p>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <a id="mCall" href="#" class="btn-action" style="flex:1; background:var(--primary); color:white; padding:12px; border-radius:10px; text-align:center;"><i class="fas fa-phone"></i> Ø§ØªØµØ§Ù„</a>
                <a id="mWa" href="#" class="btn-action" style="flex:1; background:var(--secondary); color:white; padding:12px; border-radius:10px; text-align:center;"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a>
            </div>
            <a id="mLoc" href="#" target="_blank" style="display:block; margin-top:10px; background:#fff8e1; color:#f39c12; padding:12px; border-radius:10px; text-align:center; font-weight:bold;"><i class="fas fa-map-marker-alt"></i> Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
    const sheetID = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQxk-tGJ65-hOGtlnVUHDmDUohw1zFIFLDlIng-OlmH35mti_kqInGBCl3gNpUUeL9j5VRMx_x7A8bn/pub?gid=965965865&single=true&output=csv";
    const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(sheetID);

    let db = [], favs = JSON.parse(localStorage.getItem('wasla_favs')) || [];
    let currentView = 'home'; // home, fav, offers

    function fixImg(u) {
        if(!u || u.length<5) return 'https://via.placeholder.com/400x250?text=WASLA';
        let id = u.match(/id=([a-zA-Z0-9_-]+)/) || u.match(/\/d\/([a-zA-Z0-9_-]+)/);
        return id ? `https://lh3.googleusercontent.com/d/${id[1]}=s600` : u;
    }

    function init() {
        Papa.parse(proxy, { download:true, header:false, skipEmptyLines:true, complete: (res) => {
            db = res.data.slice(1).map((r, i) => ({
                id: i,
                name: r[1],
                cat: getCat(r[2]),
                sub: r[3],
                area: r[4],
                desc: r[5],
                ph: r[6],
                wa: r[7],
                img: fixImg(r[8]),
                loc: r[9],
                offer: r[10],
                live: (r[11] && r[11].includes('TRUE')),
                feat: (r[12] && r[12].includes('TRUE'))
            })).filter(x => x.name);
            render();
        }});
    }

    function getCat(t) {
        if(!t) return 'other'; const s = t.trim();
        if(s.includes('Ù…Ø·Ø§Ø¹Ù…')) return 'food';
        if(s.includes('Ù…Ø§Ø±ÙƒØª')) return 'market';
        if(s.includes('Ø·Ø¨')) return 'medical';
        if(s.includes('ØµÙŠØ§Ù†Ø©')) return 'maintenance';
        if(s.includes('ØªØ¹Ù„ÙŠÙ…')) return 'education';
        if(s.includes('Ù…ÙˆØ§ØµÙ„Ø§Øª')) return 'transport';
        if(s.includes('Ø­ÙƒÙˆÙ…ÙŠ')) return 'gov';
        return 'other';
    }

    function render(filterCat = 'all', search = '') {
        const g = document.getElementById('grid');
        g.innerHTML = '';

        let list = db;

        // 1. ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³ÙÙ„ÙŠ (Home / Fav / Offers)
        if (currentView === 'fav') {
            list = db.filter(x => favs.includes(x.id));
            if(list.length === 0) { g.innerHTML = '<div style="text-align:center; padding:50px; grid-column:1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ¶Ù„Ø© Ø¨Ø¹Ø¯ â¤ï¸</div>'; return; }
        } else if (currentView === 'offers') {
            list = db.filter(x => x.offer && x.offer.length > 2);
            if(list.length === 0) { g.innerHTML = '<div style="text-align:center; padding:50px; grid-column:1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ”¥</div>'; return; }
        }

        // 2. ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙ†ÙŠÙ
        list = list.filter(x => {
            const catMatch = (filterCat === 'all' || x.cat === filterCat);
            const searchMatch = x.name.toLowerCase().includes(search) || (x.desc && x.desc.includes(search));
            return catMatch && searchMatch;
        });

        // ØªØ±ØªÙŠØ¨
        list.sort((a,b) => (b.live - a.live) || (b.feat - a.feat));

        if(list.length === 0) { g.innerHTML = '<div style="text-align:center; padding:50px; grid-column:1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ğŸ”</div>'; return; }

        list.forEach(x => {
            const isFav = favs.includes(x.id) ? 'active' : '';
            const featClass = x.feat ? 'featured' : '';
            const liveBadge = x.live ? '<div class="status-dot"></div>' : '';
            const offerTag = x.offer ? `<span style="color:#e74c3c; font-size:0.75rem; display:block; margin-top:5px;">ğŸ”¥ ${x.offer}</span>` : '';

            g.innerHTML += `
            <div class="card ${featClass}" onclick="openM(${x.id})">
                ${liveBadge}
                <div class="card-tools">
                    <div class="tool-btn fav ${isFav}" onclick="toggleFav(${x.id}, event)"><i class="fas fa-heart"></i></div>
                    <div class="tool-btn" onclick="shareItem('${x.name}', '${x.desc}', event)"><i class="fas fa-share"></i></div>
                </div>
                <img src="${x.img}" class="card-img" referrerpolicy="no-referrer" loading="lazy">
                <div class="card-body">
                    <h3>${x.name}</h3>
                    <div class="sub-text"><i class="fas fa-tag"></i> ${x.sub}</div>
                    <div class="sub-text"><i class="fas fa-map-marker-alt"></i> ${x.area}</div>
                    ${offerTag}
                </div>
            </div>`;
        });
    }

    // --- Ø§Ù„Ù…Ù†Ø·Ù‚ (Logic) ---
    
    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ©
    window.switchTab = (view, el) => {
        currentView = view;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        
        // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©
        if(view === 'home') {
            document.getElementById('catsContainer').style.display = 'block';
            document.querySelector('.search-container').style.display = 'block';
        } else {
            document.getElementById('catsContainer').style.display = 'none';
            document.querySelector('.search-container').style.display = 'none';
        }
        render();
    };

    // Ø§Ù„Ù…ÙØ¶Ù„Ø©
    window.toggleFav = (id, e) => {
        e.stopPropagation();
        if(favs.includes(id)) favs = favs.filter(i => i !== id);
        else favs.push(id);
        localStorage.setItem('wasla_favs', JSON.stringify(favs));
        render(document.querySelector('.cat-chip.active').innerText === 'Ø§Ù„ÙƒÙ„' ? 'all' : '...', document.getElementById('search').value);
    };

    // Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    window.shareItem = (name, desc, e) => {
        e.stopPropagation();
        const text = `Ø´ÙˆÙ Ø§Ù„Ù…ÙƒØ§Ù† Ø¯Ù‡ ÙÙŠ Ø­Ø¯Ø§Ø¦Ù‚ Ø§Ù„Ø¹Ø§ØµÙ…Ø©:\n*${name}*\n${desc}\n\nÙ…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ ÙˆØµÙ„Ø©!`;
        if (navigator.share) {
            navigator.share({ title: name, text: text, url: window.location.href });
        } else {
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
    };

    // Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¨Ø­Ø«
    window.filter = (c, el) => {
        document.querySelectorAll('.cat-chip').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        render(c, document.getElementById('search').value);
    };
    document.getElementById('search').addEventListener('input', (e) => {
        // Ø§Ù„Ø¨Ø­Ø« ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹
        render('all', e.target.value); 
    });

    // ØªÙØ§ØµÙŠÙ„
    window.openM = (id) => {
        const x = db.find(i => i.id === id);
        document.getElementById('mName').innerText = x.name;
        document.getElementById('mSub').innerText = `${x.sub} - ${x.area}`;
        document.getElementById('mDesc').innerText = x.desc || '';
        document.getElementById('mImg').src = x.img.replace('=s600','=s1000');
        
        const loc = document.getElementById('mLoc');
        if(x.loc) { loc.style.display='block'; loc.href=x.loc; } else loc.style.display='none';

        document.getElementById('mCall').href = `tel:${x.ph}`;
        document.getElementById('mWa').href = `https://wa.me/${x.wa}`;
        document.getElementById('modal').style.display = 'block';
    }
    window.closeM = () => document.getElementById('modal').style.display = 'none';

    // ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (PWA)
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('installBtn');
        btn.style.display = 'block';
        btn.addEventListener('click', () => {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choice) => {
                if (choice.outcome === 'accepted') btn.style.display = 'none';
                deferredPrompt = null;
            });
        });
    });

    init();
</script>
</body>
</html>
